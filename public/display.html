<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Affichage TV</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #fff;
        color: #d60000;
        font-size: 10em;
        font-weight: bold;
        font-family: Arial, sans-serif;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="display">Numéro 0</div>

    <script>
      const display = document.getElementById("display");
      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const ws = new WebSocket(`${protocol}://${window.location.host}`);

      let currentNumero = 0;

      // ✅ File d’attente audio
      const audioQueue = [];
      let isPlaying = false;

      function playNextInQueue() {
        if (isPlaying || audioQueue.length === 0) return;

        isPlaying = true;
        const { numero } = audioQueue.shift();

        // recréer systématiquement les objets Audio
        const bip = new Audio("bip.mp3");
        const numSound = new Audio(`${numero}.mp3`);

        bip
          .play()
          .then(() => {
            bip.onended = () => {
              setTimeout(() => {
                numSound
                  .play()
                  .catch((err) => console.log("Erreur num :", err));

                numSound.onended = () => {
                  isPlaying = false;
                  playNextInQueue(); // joue le suivant si dispo
                };
              }, 200); // petit délai entre bip et numéro
            };
          })
          .catch((err) => {
            console.log("Erreur bip :", err);
            isPlaying = false;
            playNextInQueue();
          });
      }

      function annoncerNumero(numero) {
        audioQueue.push({ numero });
        playNextInQueue();
      }

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.numero !== undefined) {
          currentNumero = data.numero;
          display.textContent = "Numéro " + currentNumero;
          annoncerNumero(currentNumero);
        }

        if (data.action === "repeat") {
          annoncerNumero(currentNumero);
        }
      };
    </script>
  </body>
</html>
